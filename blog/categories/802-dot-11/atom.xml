<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: 802.11 | #error NO_MONEY]]></title>
  <link href="http://enukane.github.io/blog/categories/802-dot-11/atom.xml" rel="self"/>
  <link href="http://enukane.github.io/"/>
  <updated>2018-05-08T20:03:30+09:00</updated>
  <id>http://enukane.github.io/</id>
  <author>
    <name><![CDATA[n_kane]]></name>
    <email><![CDATA[enukane@glenda9.org]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[2018-05-08 論文100本ノック 1: Performance Analysis of IEEE 802.11ac DCF with Hidden Nodes]]></title>
    <link href="http://enukane.github.io/blog/2018/05/08/2018-05-08-100papers-00/"/>
    <updated>2018-05-08T19:39:17+09:00</updated>
    <id>http://enukane.github.io/blog/2018/05/08/2018-05-08-100papers-00</id>
    <content type="html"><![CDATA[<p>人もすなる論文100本ノックといふものを、我もしてみむとてするなり。
どこまで続くか分からないけどぼちぼち読んでたりしているのを吐き出す良い機会ではあるのでちょびちょびやっていこうと思う。</p>

<p>フォーマットは以下の落合先生フォーマットをアレンジしたものを使う。</p>

<ul>
<li><a href="http://lafrenze.hatenablog.com/entry/2015/08/04/120205">高速で論文がバリバリ読める落合先生のフォーマットがいい感じだったのでメモ</a></li>
</ul>


<p>だいたい以下の項目を埋めるイメージ</p>

<pre><code class="text">- from: 別のノックからの続きモノの場合、その番号。系統図書けると面白そうなので。
- 著者: ファーストオーサーの名前
- 著者団体: 著者の所属研究機関がわかるように
- 発行年: 旬のものなのかそうでないのかわかるように
- 学会: どれくらいのランクの学会のモノなのかわかるように
- どんなもの
- 技術や手法のキモはどこ？
- どうやって技術・手法の有効性を検証した？
- 議論はある？
- この中で出てきた次に読むべき論文リスト
- 所感
</code></pre>

<ul>
<li>from: none</li>
<li>著者: Zheng Chang et al</li>
<li>著者団体: Magister Solutions, Nokia Research Center, U of Jyvaskyla</li>
<li>発行年: 2012</li>
<li>学会: VTC012 Spring <a href="http://www.ieeevtc.org/vtc2012spring/">http://www.ieeevtc.org/vtc2012spring/</a></li>
<li>どんなもの

<ul>
<li>802.11 DCF x Hidden Node x 802.11acの組合せでパフォーマンス解析を行っている</li>
</ul>
</li>
<li>先行研究と比べてどこがすごい

<ul>
<li>先行研究: [1], [2]</li>
<li>新しい規格への対応: 既存802.11aまで -> 802.11acまでやる</li>
<li>Hidden Node(隠れ端末)の考慮</li>
<li>異なるプライマリチャネルを用いたOverlapping BSS環境を想定: これまでのDCFをターゲットにした研究では対象外</li>
</ul>
</li>
<li>技術や手法のキモはどこ？

<ul>
<li>どこに差異を見いだしているか</li>
<li>[1]のモデリングにblockackおよびHNの情報を考慮したモデルを構築</li>
</ul>
</li>
<li>どうやって技術・手法の有効性を検証した？

<ul>
<li>上記モデルの理論値とIEEE802.11で定められたチャネル伝搬モデル(ビットエラー起こしやすい環境)に基づくシミュレーション値で比較</li>
<li>40MHz幅のときの比較値として10STAs, 40Mhz basic DCFおよび50 STAs 40MHz basic DCFの場合に、モデルとシミュレーションがほぼ一致していることから適用できると判断</li>
<li>これを台数換えたりRTS/CTSにしたり、チャネル幅換えたりして適用し傾向を見ている</li>
<li>fig 5a: 40Mhz幅と80MHz幅の比較における検証

<ul>
<li>DCFの方式間の差異について
□ 10 STAs 40Mhzの場合だと、大きな差があり basic の方がよい
□ 50STAsやあるいは80, 160MHz幅以上だと差はほぼない</li>
<li>チャネル幅を上げる効果について

<ul>
<li>50STAs程度になると40Mhz -> 80Mhz幅に換えても、実際のところ2Mbps程度しか改善しない傾向にある</li>
<li>10STAs程度の場合、むしろ40MHz幅の方が良い場合もある(+10Mbps程度)</li>
</ul>
</li>
<li>結論

<ul>
<li>低い台数の場合、basicの方が性能が良い。ボンディング幅が狭いとより効果がある。</li>
<li>多い台数の場合、この差異はほぼなくなる</li>
<li>チャネル幅を上げることによる効果はあまりない(+2Mbps程度)</li>
</ul>
</li>
</ul>
</li>
<li>fig 5b: 80MHz幅と160Mhz幅の比較における検証

<ul>
<li>DCFの方式の差異について

<ul>
<li>basicの方が優位 (10STAsで+20Mbps,  50STAsで+5Mbps)

<ul>
<li>台数が上がると方式間の差異は縮まるが、引き続きbasicが優位</li>
</ul>
</li>
<li>チャネル幅を 80 -> 160MHzに上げるとbasic vs RTS/CTSの差が縮まる</li>
<li>50STAsの場合、RTS/CTSの方が性能がよい</li>
</ul>
</li>
<li>チャネル幅の差異について

<ul>
<li>このチャネル伝搬モデルだと80 -> 160MHzしても差異がない=> チャネル幅上げることによる効果はない？</li>
</ul>
</li>
<li>結論

<ul>
<li>低い台数の場合、basicの方が良い</li>
<li>多い台数の場合、RTS/CTSの方が良い</li>
<li>このチャネル伝搬モデルではチャネル幅を上げることによる効果はあまりない</li>
</ul>
</li>
</ul>
</li>
<li>OBSSとHNを考慮したシミュレーションの検証

<ul>
<li>BSSで同じprrimary チャネルを用いている場合 (fig 7)

<ul>
<li>それぞれのSTAがそれぞれのAPにアップリンク送信</li>
<li>BSS2が大幅にペナルティを受ける(図の下に張り付いてる4本の線</li>
<li>DCF方式間の差異について

<ul>
<li>HNにAPが直接干渉されない方(BSS1)はbasic > RTS/CTS</li>
<li>HNにAPが干渉される方(BSS2)は RTS/CTS > basic となり、むしろbasicだとほぼ通信できない</li>
</ul>
</li>
<li>チャネル幅の差異について

<ul>
<li>RTS/CTS方式の場合

<ul>
<li>上手く通信できる方はスループットが上がる</li>
<li>上手く通信出来ない方は、スループットは上がらない</li>
</ul>
</li>
<li>basic方式の場合

<ul>
<li>上手く通信できる方はスループットが上がる</li>
<li>上手く通信出来ない方はほぼ通信できないまま</li>
</ul>
</li>
</ul>
</li>
<li>結論

<ul>
<li>RTS/CTSを用いることでこのモデルではHNの影響を受ける</li>
<li>basic方式の場合、通信出来るBSSとHNの影響を受けやすいBSSとの間に、通信できないほどの不公平を生じる</li>
</ul>
</li>
</ul>
</li>
<li>異なるprimary チャネルを用いているがsecoundaryにprimaryが被ってる場合 (fig 8a)

<ul>
<li>BSS1 40MHzのセカンダリをBSS2 80MHzがprimaryとして使っている

<ul>
<li>たとえばBSS1 40MHz 44+ vs BSS2 80MHz 48-の場合</li>
<li>BSS1にとって48chはセカンダリ、BSS2にとってはプライマリ</li>
<li>STA1から40MHz転送が行われるとSTA2からの80MHz転送にプリマリで被さる</li>
</ul>
</li>
<li>プライマリがオーバーラップしている方(BSS2)ガbasicだと大きく割を食う (その文をBSS1が持っていく)</li>
<li>RTS/CTS方式だとBSS2のスループットが一定のレベルで改善する一方、BS1のスループットは低下する</li>
</ul>
</li>
<li>異なるprimaryチャネルを用いておりsecondaryにprimaryが被っていない場合 (fig 8b)

<ul>
<li>BSS1 40MHzのセカンダリとBSS2 80MHzのプライマリが被っていない場合

<ul>
<li>たとえばBSS1 40MHz 36+ vs BSS2 80MHz 48-の場合</li>
<li>36, 40チャネルは被っているがプライマリではない</li>
<li>BSS1からはSTA2は見えないので、80MHz幅転送の影響は受けない</li>
<li>STA1から40MHz転送が行われるとSTA2からの80MHz転送がセカンダリ以降で被さる</li>
</ul>
</li>
<li>fig 8aと同じ傾向

<ul>
<li>RTS/CTSで一部改善はしているが、BSS2が80MHz幅の利点を活かして通信できるほどではない</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>議論はある？

<ul>
<li>このチャネル伝搬モデルの妥当性は？イベント無線LAN環境などと比べるとどうなのだろう？</li>
<li>チャネル伝搬モデルを換えるとどうなる？換えられる対象はある？</li>
</ul>
</li>
<li>この中ででてきた次に読むべき論文リスト

<ul>
<li>[1]: モデリングの元となる論文

<ul>
<li>G.Bianchi &ldquo;Performance Analysis of the IEEE802.11 Distributed Coordination Function&rdquo; IEEE Journal on Selected Areas in Communication, vol.18, No.3, pp.535-547, Mar, 2000</li>
</ul>
</li>
<li>[8]: 本論文の調査結果として明らかになったHN x 802.11acの組合せ問題への解決策となりうる RTS/CTSの改良を扱っているらしい

<ul>
<li>M.Park &ldquo;IEEE80211ac : Dynamic Bandwidth Channel Access&rdquo; IEEE ICC 2011<a href="http://icc2011.ieee-icc.org/">http://icc2011.ieee-icc.org/</a></li>
</ul>
</li>
</ul>
</li>
<li>所感

<ul>
<li>モデルについて疑問はあるものの、DCF方式の差異、チャネル幅の差異、クライアント数の差異という観点でパラメータがどのように影響するのかが調査されているのは参考になった</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[日本の5.3GHz帯DFS対象レーダー局をプロットしてみた]]></title>
    <link href="http://enukane.github.io/blog/2017/12/02/dfs-radar-site/"/>
    <updated>2017-12-02T01:36:58+09:00</updated>
    <id>http://enukane.github.io/blog/2017/12/02/dfs-radar-site</id>
    <content type="html"><![CDATA[<p>先日参加したInternetWeek2017 NOCチーム内で、「5GHz帯 DFS 対象のレーダーが飛んでくる場所」という話題が出たので試しにプロットしてみました。</p>

<ul>
<li><a href="https://www.google.com/maps/d/viewer?mid=1HN0HXt1HLAMVClb2YfaTzyM_hLM0QVjS&amp;hl=ja&amp;usp=sharing">DFS対象レーダー局</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Got Aruba IAP-103-JP]]></title>
    <link href="http://enukane.github.io/blog/2017/05/03/iap103/"/>
    <updated>2017-05-03T23:42:11+09:00</updated>
    <id>http://enukane.github.io/blog/2017/05/03/iap103</id>
    <content type="html"><![CDATA[<p>どこからともなく予算が割り当たったことにしたので、Aruba IAP-103-JP が降ってきました。</p>

<ul>
<li><a href="http://www.arubanetworks.com/ja/products/networking/access-points/103-series/">Aruba 103 シリーズ</a></li>
</ul>


<p>機体筐体はこんな感じ。Cisco Aironet 3602i やらと比べるとだいぶコンパクトでカワイイ。</p>

<p>{% img center /images/2017-05-03/iap103.jpg 480 %}</p>

<p>裏側のネジ4つを外すと表カバー、裏カバー、基板の3つに綺麗に分かれる。分解はしやすい。</p>

<p>アンテナ(基板の表カバー側)はこんな感じ。いわゆる逆Fアンテナの模様。
見ての通りアンテナは2つだけで、2.4/5GHz帯共用らしい。</p>

<p>{% img center /images/2017-05-03/iap103_ant.jpg 480 %}</p>

<p>チップ実装面はこんな感じ。シールドを一部外した状態。
右側のシールド内のチップはAtheros AR9582-AR1A。
左の黒いヒートシンクが付いているシールドからちらっと見えている石はAtheros AR9344-BC2AでこちらはSoC。
前者で5GHz帯、後者でCPU兼2.4GHz帯を捌いてる模様。
中央上部、ACアダプタソケットとEthernetソケットの間にピンヘッダが出ている。
細かく調べてはいないがシリアルコンソールが取れるのかもしれない。</p>

<p>{% img center /images/2017-05-03/iap103_chip.png 480 %}</p>

<p>この子はIAPタイプなのでコントローラとしても動作する。ダッシュボードはこんな感じ。
1台だけだからかもしれないがCisco WLCと比べるとだいぶシンプル、というか設定できるところが少なめっぽい。よしなに調整してくれるのかな？</p>

<p>{% img center /images/2017-05-03/iap103_db_ap.png 480 %}</p>

<p>AppRFを有効にしてると以下の様に通信内容の分析がAP/クライアントの単位でできるらしい。</p>

<p>{% img center /images/2017-05-03/iap103_db_apprf.png 640 %}</p>

<p>今のところ自宅ではAP機能(アクセスモード)に用はないので、スペクトルもモニターモードで動作させている。
このモードだと「スペクトラム」メニューにて非802.11デバイス一覧や、全チャネルのチャネル使用率&amp;品質が見れるらしい。
なおアクセスモードだと動作中チャネルのそれに限定される。</p>

<p>{% img center /images/2017-05-03/iap103_mon_gen.png 480 %}
{% img center /images/2017-05-03/iap103_mon_24g.png 480 %}
{% img center /images/2017-05-03/iap103_mon_5g.png  480 %}</p>

<p>ところでIAPが一台あれば、Remote APモデルのもの仕入れて繋げて遊べたりするのかな？
AP105はヤフオクで1500〜2000円/台の価格で数多く出ており、簡単に中規模ネットワークは組めそう。
なお一部のAruba APは某用途向けにファーム/基板ごと特殊モデルと聞くので対象外になりそうではある。</p>

<p>軽くぐぐってみた限り、以下のスレッドにあるとおりクラスタのAP数上限というのはないらしい。
推奨値128とあるようだがここまで巨大なものを組む予定はないので遊ぶ分には困らなさそう。</p>

<ul>
<li><a href="https://community.arubanetworks.com/t5/Aruba-Instant-Cloud-Wi-Fi/IAP-MAX-AP-per-Cluster/td-p/214997">IAP MAX AP per Cluster</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[コミケ91 1日目の無線LAN模様]]></title>
    <link href="http://enukane.github.io/blog/2017/01/11/c91-wifi/"/>
    <updated>2017-01-11T23:59:31+09:00</updated>
    <id>http://enukane.github.io/blog/2017/01/11/c91-wifi</id>
    <content type="html"><![CDATA[<p>だんだんと自分にしか意味のない指標&amp;グラフが増えすぎてて大変に読みづらいものになったけど、
いつものやつ書きました。「C91 Wi-Fi 〜ららら、(無線的に)素敵なComiket Space〜」。</p>

<p>{% slideshare 70907756 %}</p>

<p>今回は、また自スペースが西1に戻ってきました。
そのため<a href="http://www.slideshare.net/enukane/c90-wifi-comiket-space">前回のC90 (西3だった)</a>とはまた様子が異なっています。
比較のために、次はできれば東に割り当てられたいですね。</p>

<p>今回は新要素として以下を追加しています。</p>

<ul>
<li>&ldquo;18.1 AP滞在時間のヒストグラム(10分以上のみ抽出)&rdquo;

<ul>
<li>APが見えていた時間をプロット</li>
<li>大半がヒットアンドランで0秒付近に張り付く傾向があるので、一定時間以上に絞って長期傾向を見る</li>
</ul>
</li>
<li>&ldquo;19.1 端末の滞在時間ヒストグラム(10分以上のみ抽出)&rdquo;

<ul>
<li>同上</li>
</ul>
</li>
<li>&ldquo;20. Data &amp; BlockAckフレームの収集数/s&rdquo;

<ul>
<li>&ldquo;14. 正常フレームの収集数/s&rdquo; のうち、さらに Dataフレームと Block Ackフレームに絞り込み</li>
<li>サンプリングが妥当であれば、このFPSがデータ送信の活発さの指標になりうる</li>
<li>ただし長さは考慮されない</li>
<li>ただし高レートすぎて見えないフレームは Block Ack でしか考慮されない

<ul>
<li>Block Ack またはその他の要素から、これらのフレームを復元する方法が必要</li>
</ul>
</li>
</ul>
</li>
<li>&ldquo;21. FCS OKフレームの時間的占有率&rdquo;

<ul>
<li>毎回1秒キャプチャしてた間に見つけたFCS good なフレームの Duration (秒) と 1秒内の割合の推移をプロット</li>
<li>「13. チャネル使用率」のうち、どれくらいが有効に使われていたかを判断できるはず

<ul>
<li>正確な一致には FCS bad なフレームの考慮による検証が必要 (TODO)</li>
</ul>
</li>
<li>チャネル使用率との差分が、無駄になった時間

<ul>
<li>このDurationのうち、データフレームに使えた時間と長さを考慮してチャネル使用率との対比を取ると、有効に使えた度合いが取れる？</li>
</ul>
</li>
</ul>
</li>
</ul>


<p>FCS badなフレームのDurationがどれくらい正確なのかは今後要検証。
これが正確にとれており、Durationの合計がチャネル使用率と合致するならサンプリング精度が良いという指標になりそう。</p>

<p>また、FCS badなデュレーションと
これと、プリアンブルだけの情報が上手く取れると高レートなフレームの流れが</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[2017-01-11 コミケ91で、ハニーポット無線LANアクセスポイント立てたお話]]></title>
    <link href="http://enukane.github.io/blog/2017/01/11/hap/"/>
    <updated>2017-01-11T09:35:12+09:00</updated>
    <id>http://enukane.github.io/blog/2017/01/11/hap</id>
    <content type="html"><![CDATA[<p>{:TOC}</p>

<h1>概要</h1>

<p>今冬のコミックマーケット91にて、1日目 西1 み-18a &ldquo;glenda9&rdquo; で出展するにあたって
自スペースにハニーポット無線LANアクセスポイント(以下 ハニポAP)を立てました。
ここではその提供方法、構成および結果について記述します。</p>

<p>この手のイベントでは「応仁のLAN」といった面白SSIDを告知する遊びをする人がいます。
これに倣って自分のスペース名をSSIDで告知というのも可能ですが、
せっかくAPを立てるからにはもうすこし遊びを入れたいところです。</p>

<p>もうちょっと真面目な目的としては各種プラットフォームが備えているキャプティブポータル検知の実装を見てみたい、
この手のイベントでいかにもセキュリティの甘そうなAPをおいておくと
どれくらいの人が引っかかるのか見てみたいといったモチベーションがありました。</p>

<p>ここではAPとキャプティブポータルを組み合わせてイベント環境にデプロイし、
クライアントの通信を特定コンテンツにねじ曲げて以下の様なページを強制表示するようにしつつ各種ログを収集しました。</p>

<p>{% img center /images/2017-01-11/captive-webui.png 350 %}</p>

<!---
# 目的

- APを用いた宣伝、お客さんを釣る
- どれくらいの人がハニポAPに引っかかるかをみる
- キャプティブポータル検知の仕組みを実際に引っかけて調べる

先にも述べたように単純にSSIDを「み-18a glenda9」などとして宣伝する方法もあります。
が、一般的なハニーポットとしては"Free Wi-Fi"といったそれらしいSSIDをつけておきたいところです。
威力業務妨害扱いにもなりそうなので、今回はやりませんでしたが他のFree Wi-Fiで用いている
SSIDをつけるという案もあります。
コミケの環境では、PCというよりスマホ・タブレットが主として用いられると思われ
またさらにいえばWi-Fiよりは3G/LTEを用いるであろうと思われるためあまり引っかかる人はいなさそうです。
しかし、無線LANがデフォルト有効かつ暗号化なしSSIDに自動的に接続しに行くデバイスや、
テザリング接続時にたまたまフリーっぽいSSIDを見つけて手動接続するユーザはいると思われます。
これらをターゲットとしてSSIDを告知します。

各種プラットフォームではそれぞれ [HOW AUTOMATIC DETECTION OF CAPTIVE PORTAL WORKS](https://success.tanaza.com/s/article/How-Automatic-Detection-of-Captive-Portal-works)にあるようなキャプティブポータル検知の仕組みを導入しています。
これを実際に調べるとともに、この際に発生する接続からアドレス取得、名前解決からHTTPアクセスまでの
一連の流れから読み取れることを探ってみます。

-->


<h1>ハニーポットAPの見え方</h1>

<p>ハニポAPのSSIDとして「  Not Free Wi-Fi」を告知するようにしました。
SSIDの先頭に半角スペースを2つ入れることで、
「0000」で始まるものやアンダースコアから始まるSSIDよりも上位に出現するようにしています。
2.4GHz帯と5GHz帯でSSIDを分けており、
下記の様に2.4GHz帯側には&#8221;-g&#8221;とのサフィクスをつけました。</p>

<p>{% img center /images/2017-01-11/not-free-wifi-ssid_hide.png 300 %}</p>

<!--- 引っかかると --->


<p>このSSIDに接続すると、
大抵のプラットフォームに入っているキャプティブポータル検知の仕組みによりスプラッシュページが表示されます。
Androidのスマホで見ると、ハニーポットAPのSSIDを選択後しばらくすると以下の画面がポップアップします。</p>

<p>{% img center /images/2017-01-11/sp-captive.jpg 300 %}</p>

<h1>ハニーポットAPの機材について</h1>

<h2>AP本体</h2>

<p>ハニーポットAPには、Buffalo WZR-HP-AG300H に OpenWRT を載せたものを用いました。</p>

<p>{% img center /images/2017-01-11/hap.png 300 %}</p>

<p>C90で同様の試みをしたときは Raspberry Pi と USB Wi-Fi アダプタを用いていました(以下)。
その際は、混雑している2.4GHz帯でしか運用せず出力も弱めであったため、
あまり接続数を稼げませんでした。</p>

<p>{% img center /images/2017-01-11/old-hap.png 300 %}</p>

<p>WZR-HP-AG300H は家庭用APとしてそれなりにきちんとしたアンテナを備え、
2.4GHz/5GHz帯の同時運用も可能です。
OpenWRT を導入できカスタマイズ性も高いため今回はこれを用いてハニーポットAPを実装しました。</p>

<h2>APへの電源供給</h2>

<p>WZR-HP-AG300Hの消費電力は最大13.2Wであり、付属のACアダプタは定格 12V/2.0A となっています。
通常のUSBモバイルバッテリーではここまでの電圧は出せないため、
簡単にやるにはACが取れる電源などの大きめのバッテリーを用意する必要があります。
これらは価格も高い上にでかいし重いしで大変に邪魔なので、
ここでは以下のページに従ってQuickCharge 2.0対応のバッテリー(今回は AUKEY PB-T4 を利用)から12Vを引き出すようにしました。</p>

<ul>
<li><a href="https://lowreal.net/2015/12/07/3">Quick Charge 2.0 電源から 12V とる</a></li>
</ul>


<p>なお上記ページのコードでは上手く動かなかったため、
挿入するディレイの長さを変更して運用しています。コードは下記をご参照ください。</p>

<ul>
<li><a href="https://gist.github.com/enukane/26f3af8938ed2a775296f472b1c71168">https://gist.github.com/enukane/26f3af8938ed2a775296f472b1c71168</a></li>
</ul>


<p>後述するとおり 10000mAh のバッテリーで6時間程度は運用できました。
基板に起こすのは間に合わなかったので Arduino そのままとブレッドボードで動かしていました。
たまに結線が外れてリブートしてたり。。。。</p>

<p>{% img center /images/2017-01-11/hap-power.jpg 350 %}</p>

<h2>簡易キャプティブポータル on OpenWRT</h2>

<p>簡易キャプティブポータル実現のため、以下の細工を入れています。</p>

<ul>
<li>管理用WebUIはWAN側インタフェースでのみ受付</li>
<li>LAN から WAN への通信を全て遮断</li>
<li>DHCPで配布するDNSサーバを自身(10.0.0.1)に設定</li>
<li>DNSサーバにて全てのAレコードのクエリに対して自身のアドレスで応答</li>
<li>LAN側(キャプティブポータル提供側)では Apache で HTTP アクセスを待ち受け

<ul>
<li>全てのHTTPアクセスを /index.html に置き換え</li>
</ul>
</li>
</ul>


<p>dnsmasqのレコード上書き機能を用いて全てのホスト名に対して自分のアドレスを返すことで、
アクセスを自身にねじ曲げます。
現状 /etc/init.d/dnsmasq にて dnsmasq コマンドの引数に以下を
加えてこれを実現しています。本来的には /etc/config/dhcp に list address の
行を追加すれば動くはずですが、上手く動作しないようでした。</p>

<pre><code>--address='/#/10.0.0.1'
</code></pre>

<p>キャプティブポータルとして HTTP アクセスを受け付ける側には Apache を用います。
上記 DNS の細工により、HTTP アクセスはこちらに向きますがパスは不定のためリダイレクト等が必要です。
OpenWRT デフォルトの apache では mod_rewrite が使えないため、
AliasMatch でこれを実現します。</p>

<pre><code>AliasMatch ^/.+$ /root/www/index.html
&lt;Directory "/root/www"&gt;
    Options Indexes FollowSymLinks SymLinksIfOwnerMatch
    AllowOverride None
    Order allow,deny
    Allow from all
&lt;/Directory&gt;
</code></pre>

<p>これにより全てのHTTP アクセスに対して /index.html の中見を返すようになります。
このHTMLファイル中に、先に挙げたWebページを詰め込んでおきます。</p>

<h2>設置場所</h2>

<p>ハニーポットAP は コミックマーケット91 1日目 (2016/12/29) の西ホール1、
み-18a の机の上に設置しました。西ホールのだいたい赤丸の位置に自スペースがあります。</p>

<p>{% img center /images/2017-01-11/map.png 200 %}</p>

<p>{% img /images/2017-01-11/my-space_cap.png %}</p>

<p>机の上の可能な限り高いところに、
設置しましたができればポスタースタンドなどにくくりつけてより高さを稼ぎたいところではあります。</p>

<h1>提供結果</h1>

<p>ハニーポットAPの提供は 12/29 09:05:29 から 15:09:15 までの期間、6時間3分46秒に渡って実施しました。</p>

<h2>無線LAN</h2>

<p>接続しにきたユニーククライアント数は 62 台でした。
この値は、ログ中の接続(Authentication)イベントに紐付くMACアドレスのユニークアドレス数を計上したものです。
なお、いくつかの端末は Authentication Response に対してACKを返せていないため実際にAssociationまで至ったクライアントは
56 台です。</p>

<p>MACアドレスのOUIからベンダ名を引き、分布を図示した物が以下になります。
全体でベンダは10種類でした。コミケという利用環境上、大半がスマートフォンであると推測できます。
この中でも大半が Apple (おそらくiPhone/iPad) と Huawei で占められています。
&ldquo;IEEE Registration Authority&#8221;という名前になっているものがありますが、
一部のスマホでは自社のベンダ名を登録していないためこうなっているようです。</p>

<p><img src="/images/2017-01-11/sta_oui_histogram.png" alt="sta-oui-histogram" /></p>

<p>ハニーポットAPでは2.4/5GHz帯でそれぞれ別のSSIDを告知しています。
以下は帯域毎のユニーク接続クライアント数の分布です。
2.4GHz帯は18端末、5GHz帯は42端末と後者に寄っています。
接続イベント数上も2.4GHz帯は 33回、5GHz帯は 63回となっており、
5GHz帯側に接続しにくることが多かったようです。</p>

<p><img src="/images/2017-01-11/sta_per_band.png" alt="sta-per-band" /></p>

<p>以下は端末の接続持続時間のヒストグラムです。端末が接続してから切断するまでの期間(秒)と発生回数をプロットしています。
10秒単位で丸めています。大半は1分以内ですが、最長で1030秒(17分程度)の場合もあったようです。
300秒にて山がありますが、これは5分毎に走るGTKの更新失敗やらのタイムアウトに起因するものと推測しています。
移動が激しいコミケのような環境では、接続後そのまま明示的に切断せずにクライアントが離脱することが多いため、
このような傾向があるものと考えています。</p>

<p><img src="/images/2017-01-11/sta_dur_histogram.png" alt="sta-dur-histogram" /></p>

<h2>DHCP</h2>

<p>DHCPサーバがアドレスを割り当てた端末は 50 台でした。
先に述べたとおり、Assocした端末数は56端末であるため6台はDHCPによるアドレス取得まで至らなかったようです。</p>

<p>割り当てたアドレスは10.0.0.0/8から 45 アドレス分でした。
dnsmasqは比較的割り当てアドレスをばらけさせる傾向にありますが、うち5アドレスは重複して配布しています。
デフォルトでは DHCP Lease Time が 1h であるため再利用されたようです。</p>

<p>DHCPクライアントは DHCP Requestのオプションとしてホスト名を付与する場合があります。
このホスト名のユニーク数は今回 39 種でした。
ホスト名文字列として何が付与されるかは端末により異なります。
iOS系だと<strong>〜のiPhone</strong>といった形式、
androidだと<strong>android-XXXXXXXX</strong>といった乱数要素を含んだ文字列を用いる場合があります。
詳細は伏せますが、今回は以下の様な文字列が検出されました。</p>

<ul>
<li>iPhone/iPod Touchと推測されるもの(&ldquo;iphone&rdquo;, &ldquo;ipod&#8221;が含まれる): 14 個</li>
<li>iPadと推測されるもの(&ldquo;ipad&#8221;が含まれる): 5 個</li>
<li>androidと推測されるもの

<ul>
<li>&ldquo;android-XXXXX&rdquo; の形式: 12 個</li>
<li>機種名: 4 個</li>
</ul>
</li>
<li>不明(端末を推測可能な文字列を含まない): 4 個</li>
</ul>


<p>上記に挙げたとおり android にてホスト名に機種名を用いている例が4つありました。
以下の通り全てHuawei製品であり、このベンダでは一律このポリシーを採っているのかもしれません。</p>

<ul>
<li>HUAWEI_P9</li>
<li>HUAWEI_P9_lite</li>
<li>HUAWEI_Mate_9</li>
<li>Honor_8</li>
</ul>


<h2>DNS クエリ</h2>

<p>ハニポAPで動作しているDNSサーバでは期間中に合計556回 DNS クエリを受け取っており、
この対象レコードの内訳は以下の通りです。</p>

<ul>
<li>Aレコード: 504回</li>
<li>AAAAレコード: 50回</li>
<li>PTRレコード: 2回</li>
</ul>


<p>合計 123 個の名前にたいしてクエリを受信しました。
以下はその中で回数の多いほうからトップ10をプロットしたグラフです。
<em>connectivitycheck.gstatic.com</em> や <em>captive.apple.com</em>
のようにキャプティブポータル検知に用いられるホストが多く現れています。
またプッシュ通知を司るホスト向けの通信が多いことも伺えます。</p>

<p><img src="/images/2017-01-11/query_top10.png" alt="query-top10" /></p>

<p>AAAA レコードへのクエリのみを抽出すると、以下の5ホストに対してのクエリを受信していました。
IPv6はサポートしていないため、一律NODATAを返しています。</p>

<ul>
<li>connectivitycheck.gstatic.com</li>
<li>clients3.google.com</li>
<li>mobile.pipe.aria.microsoft.com</li>
<li>a.config.skype.com</li>
<li>b.config.skype.com</li>
</ul>


<h2>キャプティブポータル</h2>

<p>名前でねじ曲げられた先のキャプティブポータルに対するアクセスは以下のようになっています。</p>

<ul>
<li>HTTPアクセス回数: 246 回</li>
<li>HTTPアクセスのユニーク送信元アドレス数: 43 個

<ul>
<li>うち5つのアドレスは重複割り当ての可能性あり</li>
</ul>
</li>
<li>HTTPアクセス対象ホストのユニーク数: 21 ホスト

<ul>
<li>先のクエリ対象ホストが123だったのに比べるとだいぶ少なめ</li>
<li>HTTPのみ対象のため？</li>
</ul>
</li>
</ul>


<p>以下はアクセス数の多いほうから、ホスト名のトップ10をプロットしたグラフです。
やはりキャプティブポータル検知用ホストへのアクセスが多めです。</p>

<p><img src="/images/2017-01-11/http_host_histogram.png" alt="http-host-histogram" /></p>

<p>アクセス数のヒストグラムをURL全体に拡張し、そのトップ10を並べたものを以下に記載します。
全体では31個のURLに対するアクセスを記録しています。</p>

<p><img src="/images/2017-01-11/http_url_histogram.png" alt="http-url-histogram" /></p>

<p>通常のWebアクセスらしきものや、Simejiの通信なども見えますが
大多数はキャプティブポータル検知用のURLに対するアクセスです。</p>

<ul>
<li>Apple系

<ul>
<li><a href="http://captive.apple.com/hotspot-detect.html">http://captive.apple.com/hotspot-detect.html</a></li>
<li><a href="http://captive.apple.com/XXXXXXXXXX/YYYYYYYYYYY/ZZZZZZZZZZZZZZZZZZZZZ.html">http://captive.apple.com/XXXXXXXXXX/YYYYYYYYYYY/ZZZZZZZZZZZZZZZZZZZZZ.html</a>

<ul>
<li>captive.apple.com はどのパスでも固定の応答が返る模様</li>
</ul>
</li>
</ul>
</li>
<li>Android系

<ul>
<li><a href="http://connectivitycheck.gstatic.com/generate_204">http://connectivitycheck.gstatic.com/generate_204</a></li>
<li><a href="http://clients3.google.com/generate_204">http://clients3.google.com/generate_204</a></li>
<li><a href="http://connectivitycheck.android.com/generate_204">http://connectivitycheck.android.com/generate_204</a></li>
<li><a href="http://10.0.0.1/generate_204">http://10.0.0.1/generate_204</a></li>
</ul>
</li>
</ul>


<p>今回検出したアクセス時のUser-Agentは大別すると以下の4種類に分けられそれぞれ一定の役割のもと
用いられているようです。</p>

<ul>
<li>CaptiveNetworkSupport系</li>
<li>Dalvik系</li>
<li>WebKit系</li>
<li>その他</li>
</ul>


<p>CaptivePortalSupportは主に captive.apple.com 向けの通信に使われていました。
ただしこれだけ、と言うわけではなく以下の様に CaptiveNetworkSupport系とMozilla系のUser-Agentを交互に利用しているようです。</p>

<pre><code>10.0.0.73 GET /hotspot-detect.html FryingPan.lan captive.apple.com "CaptiveNetworkSupport-325.10.1 wispr" 200
10.0.0.73 GET /hotspot-detect.html FryingPan.lan captive.apple.com "Mozilla/5.0 (iPhone; CPU iPhone OS 9_3_3 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Mobile/13G34" 200
</code></pre>

<p>CaptiveNetworkSupportを含むUser-Agent文字列には以下のパターンが存在していました。
WISPrの仕様上、User-Agent文字列は &ldquo;WISPR!任意の文字列&rdquo; ということになっているので
CaptiveNetworkSupportの文字列の出典および後続する数値列の意味は不明です。</p>

<pre><code>CaptiveNetworkSupport-346 wispr
CaptiveNetworkSupport-325.10.1 wispr
CaptiveNetworkSupport-277.10.5 wispr
CaptiveNetworkSupport-306.20.1 wispr
</code></pre>

<p>Android向けであると推測される connectivitycheck.gstatic.com等へのアクセスは主に Dalvik系 User-Agent から
なされています。が、Apple系とおなじくMozilla系Uer-Agentでのアクセスも確認されています。</p>

<pre><code>10.0.0.13 GET /generate_204 FryingPan.lan connectivitycheck.gstatic.com "Dalvik/2.1.0 (Linux; U; Android 7.0; Nexus 6 Build/NBD91P)" 200
10.0.0.13 GET /generate_204 FryingPan.lan connectivitycheck.gstatic.com "Mozilla/5.0 (Linux; Android 7.0; Nexus 6 Build/NBD91P; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/55.0.2883.91 Mobile Safari/537.36" 200
</code></pre>

<!---

- "KT/6.0.1 An/4.4.2 ko"
  - アプリ内の広告表示アクセスっぽい
- なし
  - simejiっぽい
- "iPad5,3/9.3.3 (13G34)"
  - iOSのPush通知関連？
- "dianxinos-user-agent"
  - Baidu系っぽい
- "LINE/2016.1114.1637 CFNetwork/758.5.3 Darwin/15.6.0"
  - LINE?
- "DXCoreService"
- "com.baidujp.Simeji.SimejiKB/243 CFNetwork/758.5.3 Darwin/15.6.0"
  - Simeji
- "Alamofire"
  - Simejiっぽい

--->


<h1>まとめ</h1>

<ul>
<li>コミケ91 1日目にてハニーポットAPを動かしてみた</li>
<li>62人のお客さんが釣れた

<ul>
<li>うち43人程度にはキャプティブWebページを見てもらえた模様</li>
<li>前回 (C90, 10人程度) に比べてだいぶアクセスしてもらえた</li>
</ul>
</li>
<li>キャプティブポータル検知をしてるらしい動きが見れた

<ul>
<li>iphone &amp; android がメイン?</li>
<li>PC系は今回はほぼいないのもあって確認できず</li>
<li>1台だけ Ubuntu マシンがいたが、キャプティブ検知っぽい動作はしていなかった</li>
</ul>
</li>
</ul>


<h1>Future Work</h1>

<p>お次やるとしたらこう工夫しようというToDoリスト</p>

<ul>
<li>DHCP リースタイムの延長

<ul>
<li>1日程度の方が良さそう</li>
</ul>
</li>
<li>運用時の可視化方法

<ul>
<li>本当は ruby 動かして管理用 WebUI が見れるはずだったけど、上手く動かなかった</li>
</ul>
</li>
<li>自律的な時刻同期

<ul>
<li>会期中一回落ちて時刻がおかしくなった</li>
<li>3G/LTE で NTP ?</li>
</ul>
</li>
<li>電源モジュールの基板化

<ul>
<li>ブレッドボードはつらい</li>
</ul>
</li>
<li>DHCP Fingerprinting で遊びたい</li>
<li>別の場所での運用

<ul>
<li>PC が多そうな環境で見てみたい</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
</feed>
